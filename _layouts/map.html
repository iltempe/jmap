---
layout: page_map
---

{% include head_map.html %}

<style>
  #map{
    height: 800px;
    {% if page.streetview %}
    width: 40%;
    float:right;
    {% else %}
    width: 100%;
    {% endif %}
  }
  #mly{
      height: 800px;
      width: 60%;
      float:left;
    }
</style>

<article>
  {% if page.streetview %}
  <div id="mly"></div>
  {% endif %}
  <div id="map"></div>


  <script>
    //setting icons
    var Marker = L.AwesomeMarkers.icon({
    icon: '{{page.marker.icon}}',
    prefix: 'fa',
    markerColor: '{{page.marker.color}}'});

    var markerList=[];
    var popupList=[];

    {% if page.dataset %}
      //find the dataset
      {% assign data_file = page.dataset %}
      //find the coordinates in the dataset
      {% for member in site.data[data_file] %}
        markerList.push([{{member.lat}}, {{member.lon}}]);
        popupList.push(["{{member[page.popup]}}"]);
      {% endfor %}
    {% endif %}


    // init map
    var map = L.map('map', {
        minZoom: 1,
        maxZoom: 20
    });
    var markers = L.markerClusterGroup();
    var sumLat = 0.;
    var sumLon = 0.;
    var countMarkers=0;
    var center_map=[40.737,-73.923];
    var zoom_map = 7;

    // create the style tile layer
    var style = L.tileLayer.provider('{{page.style}}').addTo(map);

    //create the markers for a dataset
     {% if page.dataset %}
    {
      for (var i=0; i<markerList.length; i++) {
              var lat = markerList[i][0];
              var lon = markerList[i][1];
              var popup = popupList[i];

              if (!isNaN(lat) && !isNaN(lon)) {
                var markerLocation = new L.LatLng(lat, lon);
                var marker = new L.Marker(markerLocation, {icon: Marker});
                {% if page.cluster == true %}
                {
                  markers.addLayer(marker);
                }else{
                  map.addLayer(marker);
                }{% endif %}
                if(popup != "")
                {
                  marker.bindPopup(''+popup);
                }
                sumLat += lat;
                sumLon += lon;
                countMarkers++;
              }
      }
  }{% endif %}

    //create clusters
    {% if page.cluster == true %}
    {
      map.addLayer(markers);
    }{% endif %}

    //set the map view
    {% if page.dataset %}
    {
      center_map=[sumLat / countMarkers, sumLon / countMarkers];
    }{% endif %}

    {% if page.view %}
    {
      {% if page.view.center_lat %}
      {
        center_map=[{{page.view.center_lat}},{{page.view.center_lon}}];
      }{% endif %}
      {% if page.view.zoom %}
      {
        zoom_map={{page.view.zoom}};
      }{% endif %}
    }{% endif %}

    //any post to be mapped here?
    center_map=JekyllMapPosts();

    map.addLayer(style).setView(center_map,zoom_map);

    //set streetview with Mapillary
    {% if page.streetview %}
      {
        var mly = new Mapillary.Viewer(
            'mly',
            '{{site.mapillary_client_id}}',
            '{{page.streetview.mapillary_photo_id}}');
        var marker1;
        mly.on(Mapillary.Viewer.nodechanged, function (node) {
            var latLon = [node.latLon.lat, node.latLon.lon];
            if (!marker1) {
                marker1 = L.marker(latLon);
                marker1.addTo(map);
            } else {
                marker1.setLatLng(latLon);
            }
            map.setView(latLon);
        });
        window.addEventListener('resize', function() { mly.resize(); });
      }{% endif %}

//manages post mapping
function JekyllMapPosts() {

    this.map;

    var center_map1 = [0,0];
    var sumLat1 = 0.;
    var sumLon1 = 0.;
    var countMarkers1 = 0;

    this.data = {
      type: 'FeatureCollection',
      features: [
        {% for post in site.posts %}
          {% if post.map == page.title %}
              {
                'type': 'Feature',
                'properties': '{{ post.title }}',
                'link':'{{post.url | prepend: site.baseurl}}',
                'geometry': {
                  'type': 'Point',
                  'coordinates': [
                    {{ post.lon }},
                    {{ post.lat }}
                  ]
                }
              },
            {% endif %}
          {% endfor %}
      ]
    };

    {% for post in site.posts %}
      {% if post.map == page.title %}
          {
            lat1 = {{ post.lat }};
            lon1 = {{ post.lon }};
          }
          {% endif %}
    {% endfor %}

  var myPostLayer = L.geoJSON(data, {onEachFeature: function (features, layer) {
    layer.bindPopup('<a href='+features.link+' itemprop="url">'+features.properties+'</a>');
  }}).addTo(map);
  center_map1=[lat1 , lon1];
  myPostLayer.addData(this.data);
  return center_map1;
}
</script>
</article>